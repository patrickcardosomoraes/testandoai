name: Post Di치rio Autom치tico

on:
  schedule:
    # Hor치rios: 8h, 14h e 20h (UTC = 5h, 11h, 17h no Brasil)
    - cron: '0 8 * * *'
    - cron: '0 14 * * *'
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  gerar-post:
    runs-on: ubuntu-latest

    steps:
      - name: 游댃 Clonar o reposit칩rio
        uses: actions/checkout@v3

      - name: 游냀 Instalar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 游닍 Instalar depend칡ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 游늯 Criar vari치veis de ambiente
        run: echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env

      - name: 游뱄 Rodar o script de gera칞칚o
        run: |
          USADOS_PATH = "logs/temas_usados.txt"
          os.makedirs("logs", exist_ok=True)
          if not os.path.exists(USADOS_PATH):
              with open(USADOS_PATH, "w") as f:
                  f.write("")

          with open(USADOS_PATH, "r") as f:
              usados = f.read().splitlines()

          temas_alta = [t for t in temas_alta if slugify(t[0]) not in usados]
          temas_media = [t for t in temas_media if slugify(t[0]) not in usados]
          temas_longtail = [t for t in temas_longtail if slugify(t[0]) not in usados]

          if not temas_alta and not temas_media and not temas_longtail:
              os.remove(USADOS_PATH)
              print("游대 Todos os temas foram utilizados. Reiniciando a lista para novo ciclo.")
              exit()

          for titulo, descricao in temas:
              with open(USADOS_PATH, "a") as f:
                  f.write(slugify(titulo) + "\n")

      - name: 游닋 Commit e Push dos novos posts
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add posts/ public/results/ logs/
          git commit -m "游닇 Post autom치tico gerado por IA" || echo "Nenhuma mudan칞a"
          git push